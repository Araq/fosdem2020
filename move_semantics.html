<!DOCTYPE html>
<html>
<head>
  <title>Nim - Move semantics</title>
  <meta name="copyright" content="&#169; 2020 Andreas Rumpf" />
  <link rel="stylesheet" type="text/css" media="screen, projection, print"
   href="slidy2/styles/slidy.css" />
   <script src="slidy2/scripts/slidy.js"
   charset="utf-8" type="text/javascript"></script>
  <style type="text/css">

span.DecNumber {color: blue}
span.BinNumber {color: blue}
span.HexNumber {color: blue}
span.OctNumber {color: blue}
span.FloatNumber {color: blue}
span.Identifier  {color: black}
span.Keyword {font-weight: bold}
span.StringLit {color: blue}
span.LongStringLit {color: blue}
span.CharLit {color: blue}
span.EscapeSequence {color: black}
span.Operator {color: black}
span.Punctation {color: black}
span.Comment, span.LongComment {font-style:italic; color: green}
span.RegularExpression  {color: DarkViolet}
span.TagStart {color: DarkViolet}
span.TagEnd {color: DarkViolet}
span.Key  {color: blue}
span.Value  {color: black}
span.RawData {color: blue}
span.Assembler  {color: blue}
span.Preprocessor {color: DarkViolet}
span.Directive  {color: DarkViolet}
span.Command, span.Rule, span.Hyperlink, span.Label, span.Reference,
span.Other  {color: black}

div.navigation {
  -moz-border-radius: 5px 5px 5px 5px;
  float: left;
  width: 30%;
  margin: 0; padding: 0;
  border: 3px outset #7F7F7F;
  background-color: #7F7F7F;
}

div.navigation ul {
  list-style-type: none;
  padding-left: 1em;
}
div.navigation ul li a, div.navigation ul li a:visited {
  font-weight: bold;
  color: #FFFFFF;
  text-decoration: none;
}
div.navigation ul li a:hover {
  font-weight: bold;
  text-decoration: none;
  color: gold;
}

div.content {
  margin-left: 30%;
  padding: 0 1em;
  border-left: 4em;
}

dl.item dd, dl.item dd p {
  margin-top:3px;
}
dl.item dd pre {
  margin-left: 15pt;
  border: 0px;
}
dl.item dt, dl.item dt pre {
  margin:  20pt 0 0 5pt;
}

pre, span.tok {
  background-color: #F9F9F9;
  border-color: #C4C4C4;
  border-style: solid;
  border-width: 1px 1px 1px 2px;
  color: black;
  line-spacing: 110%;
  font-weight: normal;
  padding: 2px;
}

span.red {
  color: #A80000;
}

hr {background-color:#9D9D9D; border:0 none; color:#9D9D9D; height:1px; width:100%;}

/*
:Author: David Goodger
:Contact: goodger@python.org
:Date: Date: 2006-05-21 22:44:42 +0200 (Sun, 21 May 2006)
:Revision: Revision: 4564
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/
/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th { border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first { margin-top: 0 ! important }
.last, .with-subtitle { margin-bottom: 0 ! important }
.hidden { display: none }
a.toc-backref { text-decoration: none ; color: black }
blockquote.epigraph { margin: 2em 5em ; }
dl.docutils dd { margin-bottom: 0.5em }
div.abstract { margin: 2em 5em }
div.abstract p.topic-title { font-weight: bold ; text-align: center }
div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ; border: medium outset ; padding: 1em }
div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title { font-weight: bold ; font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title { color: red ; font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication { margin: 2em 5em ; text-align: center ; font-style: italic }
div.dedication p.topic-title { font-weight: bold ; font-style: normal }
div.figure { margin-left: 2em ; margin-right: 2em }
div.footer, div.header { clear: both; font-size: smaller }
div.line-block { display: block ; margin-top: 1em ; margin-bottom: 1em }
div.line-block div.line-block { margin-top: 0 ; margin-bottom: 0 ;
  margin-left: 1.5em }
div.sidebar { margin-left: 1em ; border: medium outset ;
  padding: 1em ; background-color: #ffffee ; /*width: 40% ;*/ float: right ;
  clear: right }

div.sidebar p.rubric { font-family: sans-serif ; font-size: medium }
div.system-messages { margin: 5em }
div.system-messages h1 { color: red }
div.system-message { border: medium outset ; padding: 1em }
div.system-message p.system-message-title { color: red ; font-weight: bold }
div.topic { margin: 2em;}
h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }
h1.title { text-align: center }
h2.subtitle { text-align: center }
/* hr.docutils { width: 75% } */
img.align-left { clear: left }
img.align-right { clear: right }
ol.simple, ul.simple { margin-bottom: 1em }
ol.arabic { list-style: decimal }
ol.loweralpha { list-style: lower-alpha }
ol.upperalpha { list-style: upper-alpha }
ol.lowerroman { list-style: lower-roman }
ol.upperroman { list-style: upper-roman }
p.attribution { text-align: right ; margin-left: 50% }
p.caption { font-style: italic }
p.credits { font-style: italic ; font-size: smaller }
p.label { white-space: nowrap }
p.rubric { font-weight:bold;font-size:larger;color:maroon;text-align:center}
p.sidebar-title {font-family: sans-serif ;font-weight: bold ;font-size: larger }
p.sidebar-subtitle {font-family: sans-serif ; font-weight: bold }
p.topic-title {
font-weight: bold;
background-color: #6D6D6D;
border-bottom: 1px solid #000000;
border-top: 1px solid black;
color: white;
text-align: center;
margin: 0;
}
pre.address { margin-bottom: 0;margin-top:0;font-family:serif;font-size:100% }
pre.literal-block, pre.doctest-block {margin-left: 2em ;margin-right: 2em }
span.classifier {font-family: sans-serif;font-style: oblique }
span.classifier-delimiter {font-family: sans-serif;font-weight: bold }
span.interpreted {font-family: sans-serif }
span.option {white-space: nowrap }
span.pre {white-space: pre }
span.problematic {color: red }
span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation { border-left: solid 1px gray; margin-left: 1px }
table.docinfo {margin: 2em 4em }
table.docutils {margin-top: 0.5em;margin-bottom: 0.5em; border: 0 solid #9d9d9d; border-collapse: collapse; }
table.footnote {border-left: solid 1px black;margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {padding-left: 0.5em;padding-right: 0.5em;
  vertical-align: top;}

table.docutils td, table.docutils th { border-bottom:1px solid #9D9D9D; }
/* color: #4d4d4d} */

/* table.docutils td:hover, table.docinfo td:hover {color: #000000} */


table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold;text-align: left;white-space: nowrap;padding-left: 0 }

table.docutils th
{
color: black;
font-weight:normal;
background-color: #E3E3E3;
border-top: 1px solid #1d1d1d;
border-bottom: 1px solid #1d1d1d;
}

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {font-size: 100% }
ul.auto-toc { list-style-type: none }
/*a.reference { color: #E00000; font-weight:bold;}
a.reference:hover {color: #E00000;background-color: #ffff00;display: margin;
  font-weight:bold;}*/

p.pic {
    text-align: center;
}

</style>

<link rel="stylesheet" type="text/css" media="screen, projection, print"
 href="slidy2/styles/w3c-blue.css" />

</head>
<body>
  <div class="background">
    <img id="head-icon" alt="Nimrod logo"
      src="logo2.png" />
  </div>

<div class="slide">
<h1 class="title">Nim - Move semantics</h1>

</div>
<div class="slide">
<h1 id="introduction">Introduction</h1><p>&quot;Copying bad design is not good design.&quot; -- Nim's inofficial motto</p>

</div>
<div class="slide">
<h1 id="introduction">Introduction</h1><p>&quot;Copying bad design is not good design.&quot; -- Nim's inofficial motto</p>
<ul class="simple"><li>&quot;Do not copy bad designs!&quot;</li>
</ul>

</div>
<div class="slide">
<h1 id="introduction">Introduction</h1><p>&quot;Copying bad design is not good design.&quot; -- Nim's inofficial motto</p>
<ul class="simple"><li>&quot;Do not copy bad designs!&quot;</li>
<li>&quot;Recombine good bits from several sources!&quot;</li>
</ul>

</div>
<div class="slide">
<h1 id="motivating-example">Motivating example</h1><table class="line-nums-table"><tbody><tr><td class="blob-line-nums"><pre class="line-nums">1
2
3
</pre></td><td><pre id="listing_1" class="listing"><span class="Keyword">var</span> <span class="Identifier">someNumbers</span> <span class="Operator">=</span> <span class="Operator">@</span><span class="Punctuation">[</span><span class="DecNumber">299_792_458</span><span class="Punctuation">,</span> <span class="DecNumber">25_813</span><span class="Punctuation">]</span>

<span class="Identifier">someNumbers</span><span class="Operator">.</span><span class="Identifier">add</span> <span class="DecNumber">137</span></pre></td></tr></tbody></table>
</div>
<div class="slide">
<h1 id="what-happens-in-memory">What happens in memory</h1><pre>
someNumbers
-----------

Length: 2        +--------&gt;  299_792_458
Capacity: 2      |                25_813
Data: -----------+</pre>

</div>
<div class="slide">
<h1 id="what-happens-in-memory-2">What happens in memory (2)</h1><pre>
someNumbers
-----------

Length: 3        +---//---&gt;  299_792_458
Capacity: 4      |                25_813
Data: -----------+
                 |
                 +--------&gt;  299_792_458
                                  25_813
                                     137</pre>

</div>
<div class="slide">
<h1 id="shallow-copy-copy-move">Shallow copy, copy, move</h1><table class="line-nums-table"><tbody><tr><td class="blob-line-nums"><pre class="line-nums">1
2
3
</pre></td><td><pre id="listing_2" class="listing"><span class="Keyword">var</span> <span class="Identifier">someNumbers</span> <span class="Operator">=</span> <span class="Operator">@</span><span class="Punctuation">[</span><span class="DecNumber">299_792_458</span><span class="Punctuation">,</span> <span class="DecNumber">25_813</span><span class="Punctuation">]</span>
<span class="Keyword">var</span> <span class="Identifier">other</span> <span class="Operator">=</span> <span class="Identifier">someNumbers</span>
<span class="Identifier">someNumbers</span><span class="Operator">.</span><span class="Identifier">add</span> <span class="DecNumber">137</span>  <span class="Comment"># other contains a dangling pointer?</span></pre></td></tr></tbody></table>
</div>
<div class="slide">
<h1 id="shallow-copy-copy-move-2">Shallow copy, copy, move (2)</h1><table class="line-nums-table"><tbody><tr><td class="blob-line-nums"><pre class="line-nums">1
2
3
</pre></td><td><pre id="listing_3" class="listing"><span class="Keyword">var</span> <span class="Identifier">someNumbers</span> <span class="Operator">=</span> <span class="Operator">@</span><span class="Punctuation">[</span><span class="DecNumber">299_792_458</span><span class="Punctuation">,</span> <span class="DecNumber">25_813</span><span class="Punctuation">]</span>
<span class="Keyword">var</span> <span class="Identifier">other</span> <span class="Operator">=</span> <span class="Identifier">someNumbers</span>
<span class="Identifier">someNumbers</span><span class="Operator">.</span><span class="Identifier">add</span> <span class="DecNumber">137</span>  <span class="Comment"># other contains a dangling pointer?</span></pre></td></tr></tbody></table><ol class="simple"><li>Solution: Create a new sequence with the same elements. (&quot;Deep&quot; copy: C++98, Nim)</li>
<li>Solution: Use a pointer to a pointer. (Slower, more allocations.)</li>
<li>Solution: Disallow the assignment.</li>
<li>Solution: Use a GC mechanism to free the old block.</li>
<li>Solution: &quot;Steal&quot; the memory. <strong>Move</strong> the block.</li>
</ol>

</div>
<div class="slide">
<h1 id="explicit-move">Explicit move</h1><table class="line-nums-table"><tbody><tr><td class="blob-line-nums"><pre class="line-nums">1
2
3
4
5
6
</pre></td><td><pre id="listing_4" class="listing"><span class="Keyword">var</span> <span class="Identifier">someNumbers</span> <span class="Operator">=</span> <span class="Operator">@</span><span class="Punctuation">[</span><span class="DecNumber">299_792_458</span><span class="Punctuation">,</span> <span class="DecNumber">25_813</span><span class="Punctuation">]</span>
<span class="Keyword">var</span> <span class="Identifier">other</span> <span class="Operator">=</span> <span class="Identifier">move</span><span class="Punctuation">(</span><span class="Identifier">someNumbers</span><span class="Punctuation">)</span>
<span class="Comment"># someNumbers is empty now.</span>
<span class="Identifier">someNumbers</span><span class="Operator">.</span><span class="Identifier">add</span> <span class="DecNumber">137</span>

<span class="Identifier">assert</span> <span class="Identifier">someNumbers</span> <span class="Operator">==</span> <span class="Operator">@</span><span class="Punctuation">[</span><span class="DecNumber">137</span><span class="Punctuation">]</span></pre></td></tr></tbody></table>
</div>
<div class="slide">
<h1 id="implicit-move">Implicit move</h1><table class="line-nums-table"><tbody><tr><td class="blob-line-nums"><pre class="line-nums">1
2
</pre></td><td><pre id="listing_5" class="listing"><span class="Keyword">var</span> <span class="Identifier">a</span> <span class="Operator">=</span> <span class="Identifier">f</span><span class="Punctuation">(</span><span class="Punctuation">)</span>
<span class="Comment"># can move f's result into a</span></pre></td></tr></tbody></table>
</div>
<div class="slide">
<h1 id="implicit-move-2">Implicit move (2)</h1><table class="line-nums-table"><tbody><tr><td class="blob-line-nums"><pre class="line-nums">1
2
</pre></td><td><pre id="listing_6" class="listing"><span class="Keyword">var</span> <span class="Identifier">a</span> <span class="Operator">=</span> <span class="Identifier">f</span><span class="Punctuation">(</span><span class="Identifier">g</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">)</span> <span class="Comment"># can move g's result into 'f'</span>
<span class="Comment"># can move f's result into a</span></pre></td></tr></tbody></table>
</div>
<div class="slide">
<h1 id="implicit-move-3">Implicit move (3)</h1><table class="line-nums-table"><tbody><tr><td class="blob-line-nums"><pre class="line-nums">1
2
3
</pre></td><td><pre id="listing_7" class="listing"><span class="Keyword">var</span> <span class="Identifier">namedValue</span> <span class="Operator">=</span> <span class="Identifier">g</span><span class="Punctuation">(</span><span class="Punctuation">)</span>
<span class="Keyword">var</span> <span class="Identifier">a</span> <span class="Operator">=</span> <span class="Identifier">f</span><span class="Punctuation">(</span><span class="Identifier">namedValue</span><span class="Punctuation">)</span> <span class="Comment"># can move namedValue into 'f'</span>
<span class="Comment"># can move f's result into a</span></pre></td></tr></tbody></table>
</div>
<div class="slide">
<h1 id="implicit-move-4">Implicit move (4)</h1><table class="line-nums-table"><tbody><tr><td class="blob-line-nums"><pre class="line-nums">1
2
3
</pre></td><td><pre id="listing_8" class="listing"><span class="Keyword">var</span> <span class="Identifier">x</span> <span class="Operator">=</span> <span class="Operator">@</span><span class="Punctuation">[</span><span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="DecNumber">2</span><span class="Punctuation">,</span> <span class="DecNumber">3</span><span class="Punctuation">]</span>
<span class="Keyword">var</span> <span class="Identifier">y</span> <span class="Operator">=</span> <span class="Identifier">x</span> <span class="Comment"># is last read of 'x', can move into 'y'</span>
<span class="Keyword">var</span> <span class="Identifier">z</span> <span class="Operator">=</span> <span class="Identifier">y</span> <span class="Comment"># is last read of 'y', can move into 'z'</span></pre></td></tr></tbody></table>
</div>
<div class="slide">
<h1 id="sink-parameters">Sink parameters</h1><table class="line-nums-table"><tbody><tr><td class="blob-line-nums"><pre class="line-nums">1
2
3
4
5
6
</pre></td><td><pre id="listing_9" class="listing"><span class="Keyword">func</span> <span class="Identifier">put</span><span class="Punctuation">(</span><span class="Identifier">t</span><span class="Punctuation">:</span> <span class="Keyword">var</span> <span class="Identifier">Table</span><span class="Punctuation">;</span> <span class="Identifier">key</span><span class="Punctuation">:</span> <span class="Identifier">string</span><span class="Punctuation">;</span> <span class="Identifier">value</span><span class="Punctuation">:</span> <span class="Identifier">seq</span><span class="Punctuation">[</span><span class="Identifier">string</span><span class="Punctuation">]</span><span class="Punctuation">)</span> <span class="Operator">=</span>
  <span class="Keyword">var</span> <span class="Identifier">h</span> <span class="Operator">=</span> <span class="Identifier">hash</span><span class="Punctuation">(</span><span class="Identifier">key</span><span class="Punctuation">)</span>
  <span class="Identifier">t</span><span class="Operator">.</span><span class="Identifier">slots</span><span class="Punctuation">[</span><span class="Identifier">h</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="Identifier">value</span> <span class="Comment"># copy here :-(</span>

<span class="Keyword">var</span> <span class="Identifier">values</span> <span class="Operator">=</span> <span class="Operator">@</span><span class="Punctuation">[</span><span class="StringLit">&quot;a&quot;</span><span class="Punctuation">,</span> <span class="StringLit">&quot;b&quot;</span><span class="Punctuation">,</span> <span class="StringLit">&quot;c&quot;</span><span class="Punctuation">]</span>
<span class="Identifier">tab</span><span class="Operator">.</span><span class="Identifier">put</span> <span class="StringLit">&quot;key&quot;</span><span class="Punctuation">,</span> <span class="Identifier">values</span></pre></td></tr></tbody></table>
</div>
<div class="slide">
<h1 id="sink-parameters-2">Sink parameters (2)</h1><table class="line-nums-table"><tbody><tr><td class="blob-line-nums"><pre class="line-nums">1
2
3
4
5
6
</pre></td><td><pre id="listing_10" class="listing"><span class="Keyword">func</span> <span class="Identifier">put</span><span class="Punctuation">(</span><span class="Identifier">t</span><span class="Punctuation">:</span> <span class="Keyword">var</span> <span class="Identifier">Table</span><span class="Punctuation">;</span> <span class="Identifier">key</span><span class="Punctuation">:</span> <span class="Identifier">string</span><span class="Punctuation">;</span> <span class="Identifier">value</span><span class="Punctuation">:</span> <span style="background-color:#FF7700"><span class="Identifier">sink</span></span> <span class="Identifier">seq</span><span class="Punctuation">[</span><span class="Identifier">string</span><span class="Punctuation">]</span><span class="Punctuation">)</span> <span class="Operator">=</span>
  <span class="Keyword">var</span> <span class="Identifier">h</span> <span class="Operator">=</span> <span class="Identifier">hash</span><span class="Punctuation">(</span><span class="Identifier">key</span><span class="Punctuation">)</span>
  <span class="Identifier">t</span><span class="Operator">.</span><span class="Identifier">slots</span><span class="Punctuation">[</span><span class="Identifier">h</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="Identifier">value</span> <span class="Comment"># move here :-)</span>

<span class="Keyword">var</span> <span class="Identifier">values</span> <span class="Operator">=</span> <span class="Operator">@</span><span class="Punctuation">[</span><span class="StringLit">&quot;a&quot;</span><span class="Punctuation">,</span> <span class="StringLit">&quot;b&quot;</span><span class="Punctuation">,</span> <span class="StringLit">&quot;c&quot;</span><span class="Punctuation">]</span>
<span class="Identifier">tab</span><span class="Operator">.</span><span class="Identifier">put</span> <span class="StringLit">&quot;key&quot;</span><span class="Punctuation">,</span> <span class="Identifier">values</span> <span class="Comment"># last use of 'values', can move</span></pre></td></tr></tbody></table>
</div>
<div class="slide">
<h1 id="sink-parameters-3">Sink parameters (3)</h1><table class="line-nums-table"><tbody><tr><td class="blob-line-nums"><pre class="line-nums">1
2
3
4
5
6
7
</pre></td><td><pre id="listing_11" class="listing"><span class="Keyword">func</span> <span class="Identifier">put</span><span class="Punctuation">(</span><span class="Identifier">t</span><span class="Punctuation">:</span> <span class="Keyword">var</span> <span class="Identifier">Table</span><span class="Punctuation">;</span> <span class="Identifier">key</span><span class="Punctuation">:</span> <span class="Identifier">string</span><span class="Punctuation">;</span> <span class="Identifier">value</span><span class="Punctuation">:</span> <span style="background-color:#FF7700"><span class="Identifier">sink</span></span> <span class="Identifier">seq</span><span class="Punctuation">[</span><span class="Identifier">string</span><span class="Punctuation">]</span><span class="Punctuation">)</span> <span class="Operator">=</span>
  <span class="Keyword">var</span> <span class="Identifier">h</span> <span class="Operator">=</span> <span class="Identifier">hash</span><span class="Punctuation">(</span><span class="Identifier">key</span><span class="Punctuation">)</span>
  <span class="Identifier">t</span><span class="Operator">.</span><span class="Identifier">slots</span><span class="Punctuation">[</span><span class="Identifier">h</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="Identifier">value</span> <span class="Comment"># move here :-)</span>

<span class="Keyword">var</span> <span class="Identifier">values</span> <span class="Operator">=</span> <span class="Operator">@</span><span class="Punctuation">[</span><span class="StringLit">&quot;a&quot;</span><span class="Punctuation">,</span> <span class="StringLit">&quot;b&quot;</span><span class="Punctuation">,</span> <span class="StringLit">&quot;c&quot;</span><span class="Punctuation">]</span>
<span class="Identifier">tab</span><span class="Operator">.</span><span class="Identifier">put</span> <span class="StringLit">&quot;key&quot;</span><span class="Punctuation">,</span> <span class="Identifier">values</span> <span class="Comment"># not last use of 'values', cannot move</span>
<span class="Identifier">echo</span> <span class="Identifier">values</span></pre></td></tr></tbody></table><ul class="simple"><li>Warning: &quot;Passing a copy to a sink parameter.&quot;</li>
</ul>

</div>
<div class="slide">
<h1 id="sink-parameters-4">Sink parameters (4)</h1><table class="line-nums-table"><tbody><tr><td class="blob-line-nums"><pre class="line-nums">1
2
3
4
5
6
7
</pre></td><td><pre id="listing_12" class="listing"><span class="Keyword">func</span> <span class="Identifier">put</span><span class="Punctuation">(</span><span class="Identifier">t</span><span class="Punctuation">:</span> <span class="Keyword">var</span> <span class="Identifier">Table</span><span class="Punctuation">;</span> <span class="Identifier">key</span><span class="Punctuation">:</span> <span class="Identifier">string</span><span class="Punctuation">;</span> <span class="Identifier">value</span><span class="Punctuation">:</span> <span style="background-color:#FF7700"><span class="Identifier">sink</span></span> <span class="Identifier">seq</span><span class="Punctuation">[</span><span class="Identifier">string</span><span class="Punctuation">]</span><span class="Punctuation">)</span> <span class="Operator">=</span>
  <span class="Keyword">var</span> <span class="Identifier">h</span> <span class="Operator">=</span> <span class="Identifier">hash</span><span class="Punctuation">(</span><span class="Identifier">key</span><span class="Punctuation">)</span>
  <span class="Identifier">t</span><span class="Operator">.</span><span class="Identifier">slots</span><span class="Punctuation">[</span><span class="Identifier">h</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="Identifier">value</span> <span class="Comment"># move here :-)</span>

<span class="Keyword">var</span> <span class="Identifier">values</span> <span class="Operator">=</span> <span class="Operator">@</span><span class="Punctuation">[</span><span class="StringLit">&quot;a&quot;</span><span class="Punctuation">,</span> <span class="StringLit">&quot;b&quot;</span><span class="Punctuation">,</span> <span class="StringLit">&quot;c&quot;</span><span class="Punctuation">]</span>
<span class="Identifier">echo</span> <span class="Identifier">values</span>
<span class="Identifier">tab</span><span class="Operator">.</span><span class="Identifier">put</span> <span class="StringLit">&quot;key&quot;</span><span class="Punctuation">,</span> <span class="Identifier">values</span></pre></td></tr></tbody></table><ul class="simple"><li>Solution: Move code around.</li>
</ul>

</div>
<div class="slide">
<h1 id="sinkcolon-more-examples">Sink: More examples</h1><ul class="simple"><li>A <tt class="docutils literal"><span class="pre">sink</span></tt> parameter is an optimization.</li>
<li>If you get it wrong, only performance is affected.</li>
</ul>
<table class="line-nums-table"><tbody><tr><td class="blob-line-nums"><pre class="line-nums">1
2
3
4
5
6
7
</pre></td><td><pre id="listing_13" class="listing"><span class="Keyword">func</span> <span class="Punctuation">`</span><span class="Punctuation">[</span><span class="Punctuation">]</span><span class="Operator">=</span><span class="Punctuation">`</span><span class="Punctuation">[</span><span class="Identifier">K</span><span class="Punctuation">,</span> <span class="Identifier">V</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="Identifier">t</span><span class="Punctuation">:</span> <span class="Keyword">var</span> <span class="Identifier">Table</span><span class="Punctuation">[</span><span class="Identifier">K</span><span class="Punctuation">,</span> <span class="Identifier">V</span><span class="Punctuation">]</span><span class="Punctuation">;</span> <span class="Identifier">k</span><span class="Punctuation">:</span> <span class="Identifier">K</span><span class="Punctuation">;</span> <span class="Identifier">v</span><span class="Punctuation">:</span> <span class="Identifier">V</span><span class="Punctuation">)</span>

<span class="Keyword">func</span> <span class="Punctuation">`</span><span class="Operator">==</span><span class="Punctuation">`</span><span class="Punctuation">[</span><span class="Identifier">T</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="Identifier">a</span><span class="Punctuation">,</span> <span class="Identifier">b</span><span class="Punctuation">:</span> <span class="Identifier">T</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">bool</span>

<span class="Keyword">func</span> <span class="Punctuation">`</span><span class="Operator">+</span><span class="Punctuation">`</span><span class="Punctuation">[</span><span class="Identifier">T</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="Identifier">a</span><span class="Punctuation">,</span> <span class="Identifier">b</span><span class="Punctuation">:</span> <span class="Identifier">T</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">T</span>

<span class="Keyword">func</span> <span class="Identifier">add</span><span class="Punctuation">[</span><span class="Identifier">T</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="Identifier">s</span><span class="Punctuation">:</span> <span class="Keyword">var</span> <span class="Identifier">seq</span><span class="Punctuation">[</span><span class="Identifier">T</span><span class="Punctuation">]</span><span class="Punctuation">;</span> <span class="Identifier">v</span><span class="Punctuation">:</span> <span class="Identifier">T</span><span class="Punctuation">)</span></pre></td></tr></tbody></table>
</div>
<div class="slide">
<h1 id="sinkcolon-more-examples-2">Sink: More examples (2)</h1><ul class="simple"><li>A <tt class="docutils literal"><span class="pre">sink</span></tt> parameter is an optimization.</li>
<li>If you get it wrong, only performance is affected.</li>
</ul>
<table class="line-nums-table"><tbody><tr><td class="blob-line-nums"><pre class="line-nums">1
2
3
4
5
6
7
</pre></td><td><pre id="listing_14" class="listing"><span class="Keyword">func</span> <span class="Punctuation">`</span><span class="Punctuation">[</span><span class="Punctuation">]</span><span class="Operator">=</span><span class="Punctuation">`</span><span class="Punctuation">[</span><span class="Identifier">K</span><span class="Punctuation">,</span> <span class="Identifier">V</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="Identifier">t</span><span class="Punctuation">:</span> <span class="Keyword">var</span> <span class="Identifier">Table</span><span class="Punctuation">[</span><span class="Identifier">K</span><span class="Punctuation">,</span> <span class="Identifier">V</span><span class="Punctuation">]</span><span class="Punctuation">;</span> <span class="Identifier">k</span><span class="Punctuation">:</span> <span style="background-color:#FF7700"><span class="Identifier">sink</span></span> <span class="Identifier">K</span><span class="Punctuation">;</span> <span class="Identifier">v</span><span class="Punctuation">:</span> <span style="background-color:#FF7700"><span class="Identifier">sink</span></span> <span class="Identifier">V</span><span class="Punctuation">)</span>

<span class="Keyword">func</span> <span class="Punctuation">`</span><span class="Operator">==</span><span class="Punctuation">`</span><span class="Punctuation">[</span><span class="Identifier">T</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="Identifier">a</span><span class="Punctuation">,</span> <span class="Identifier">b</span><span class="Punctuation">:</span> <span class="Identifier">T</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">bool</span>

<span class="Keyword">func</span> <span class="Punctuation">`</span><span class="Operator">+</span><span class="Punctuation">`</span><span class="Punctuation">[</span><span class="Identifier">T</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="Identifier">a</span><span class="Punctuation">,</span> <span class="Identifier">b</span><span class="Punctuation">:</span> <span class="Identifier">T</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">T</span>

<span class="Keyword">func</span> <span class="Identifier">add</span><span class="Punctuation">[</span><span class="Identifier">T</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="Identifier">s</span><span class="Punctuation">:</span> <span class="Keyword">var</span> <span class="Identifier">seq</span><span class="Punctuation">[</span><span class="Identifier">T</span><span class="Punctuation">]</span><span class="Punctuation">;</span> <span class="Identifier">v</span><span class="Punctuation">:</span> <span style="background-color:#FF7700"><span class="Identifier">sink</span></span> <span class="Identifier">T</span><span class="Punctuation">)</span></pre></td></tr></tbody></table>
</div>
<div class="slide">
<h1 id="getterscolon-lending-a-value">Getters: Lending a value</h1><table class="line-nums-table"><tbody><tr><td class="blob-line-nums"><pre class="line-nums">1
2
3
</pre></td><td><pre id="listing_15" class="listing"><span class="Keyword">func</span> <span class="Identifier">get</span><span class="Punctuation">[</span><span class="Identifier">K</span><span class="Punctuation">,</span> <span class="Identifier">V</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="Identifier">t</span><span class="Punctuation">:</span> <span class="Identifier">Table</span><span class="Punctuation">[</span><span class="Identifier">K</span><span class="Punctuation">,</span> <span class="Identifier">V</span><span class="Punctuation">]</span><span class="Punctuation">;</span> <span class="Identifier">key</span><span class="Punctuation">:</span> <span class="Identifier">K</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">V</span> <span class="Operator">=</span>
  <span class="Keyword">var</span> <span class="Identifier">h</span> <span class="Operator">=</span> <span class="Identifier">hash</span><span class="Punctuation">(</span><span class="Identifier">key</span><span class="Punctuation">)</span>
  <span class="Identifier">result</span> <span class="Operator">=</span> <span class="Identifier">t</span><span class="Operator">.</span><span class="Identifier">slots</span><span class="Punctuation">[</span><span class="Identifier">h</span><span class="Punctuation">]</span> <span class="Comment"># copy here?</span></pre></td></tr></tbody></table>
</div>
<div class="slide">
<h1 id="getterscolon-lending-a-value-2">Getters: Lending a value (2)</h1><table class="line-nums-table"><tbody><tr><td class="blob-line-nums"><pre class="line-nums">1
2
3
</pre></td><td><pre id="listing_16" class="listing"><span class="Keyword">func</span> <span class="Identifier">get</span><span class="Punctuation">[</span><span class="Identifier">K</span><span class="Punctuation">,</span> <span class="Identifier">V</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="Identifier">t</span><span class="Punctuation">:</span> <span class="Identifier">Table</span><span class="Punctuation">[</span><span class="Identifier">K</span><span class="Punctuation">,</span> <span class="Identifier">V</span><span class="Punctuation">]</span><span class="Punctuation">;</span> <span class="Identifier">key</span><span class="Punctuation">:</span> <span class="Identifier">K</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">V</span> <span class="Operator">=</span>
  <span class="Keyword">var</span> <span class="Identifier">h</span> <span class="Operator">=</span> <span class="Identifier">hash</span><span class="Punctuation">(</span><span class="Identifier">key</span><span class="Punctuation">)</span>
  <span class="Identifier">result</span> <span class="Operator">=</span> <span class="Identifier">move</span> <span class="Identifier">t</span><span class="Operator">.</span><span class="Identifier">slots</span><span class="Punctuation">[</span><span class="Identifier">h</span><span class="Punctuation">]</span> <span class="Comment"># does not compile</span></pre></td></tr></tbody></table>
</div>
<div class="slide">
<h1 id="getterscolon-lending-a-value-3">Getters: Lending a value (3)</h1><table class="line-nums-table"><tbody><tr><td class="blob-line-nums"><pre class="line-nums">1
2
3
</pre></td><td><pre id="listing_17" class="listing"><span class="Keyword">func</span> <span class="Identifier">get</span><span class="Punctuation">[</span><span class="Identifier">K</span><span class="Punctuation">,</span> <span class="Identifier">V</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="Identifier">t</span><span class="Punctuation">:</span> <span style="background-color:#FF7700"><span class="Keyword">var</span></span> <span class="Identifier">Table</span><span class="Punctuation">[</span><span class="Identifier">K</span><span class="Punctuation">,</span> <span class="Identifier">V</span><span class="Punctuation">]</span><span class="Punctuation">;</span> <span class="Identifier">key</span><span class="Punctuation">:</span> <span class="Identifier">K</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">V</span> <span class="Operator">=</span>
  <span class="Keyword">var</span> <span class="Identifier">h</span> <span class="Operator">=</span> <span class="Identifier">hash</span><span class="Punctuation">(</span><span class="Identifier">key</span><span class="Punctuation">)</span>
  <span class="Identifier">result</span> <span class="Operator">=</span> <span class="Identifier">move</span> <span class="Identifier">t</span><span class="Operator">.</span><span class="Identifier">slots</span><span class="Punctuation">[</span><span class="Identifier">h</span><span class="Punctuation">]</span> <span class="Comment"># does compile, but it's a destructive read!</span></pre></td></tr></tbody></table>
</div>
<div class="slide">
<h1 id="getterscolon-lending-a-value-4">Getters: Lending a value (4)</h1><table class="line-nums-table"><tbody><tr><td class="blob-line-nums"><pre class="line-nums">1
2
3
</pre></td><td><pre id="listing_18" class="listing"><span class="Keyword">func</span> <span class="Identifier">get</span><span class="Punctuation">[</span><span class="Identifier">K</span><span class="Punctuation">,</span> <span class="Identifier">V</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="Identifier">t</span><span class="Punctuation">:</span> <span class="Identifier">Table</span><span class="Punctuation">[</span><span class="Identifier">K</span><span class="Punctuation">,</span> <span class="Identifier">V</span><span class="Punctuation">]</span><span class="Punctuation">;</span> <span class="Identifier">key</span><span class="Punctuation">:</span> <span class="Identifier">K</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span style="background-color:#FF7700"><span class="Identifier">lent</span></span> <span class="Identifier">V</span> <span class="Operator">=</span>
  <span class="Keyword">var</span> <span class="Identifier">h</span> <span class="Operator">=</span> <span class="Identifier">hash</span><span class="Punctuation">(</span><span class="Identifier">key</span><span class="Punctuation">)</span>
  <span class="Identifier">result</span> <span class="Operator">=</span> <span class="Identifier">t</span><span class="Operator">.</span><span class="Identifier">slots</span><span class="Punctuation">[</span><span class="Identifier">h</span><span class="Punctuation">]</span> <span class="Comment"># &quot;borrow&quot;, no copy, no move.</span></pre></td></tr></tbody></table>
</div>
<div class="slide">
<h1 id="reference-counting">Reference counting</h1><ul class="simple"><li>We have seen how to optimize away spurious copies.</li>
<li>The same principles apply to reference counting (= RC).</li>
<li>&quot;Copy reference&quot; ~ <tt class="docutils literal"><span class="pre">incRC(src); decRC(dest); dest = src</span></tt></li>
<li>&quot;Move reference&quot; ~ <tt class="docutils literal"><span class="pre">dest = src</span></tt></li>
<li>Led to the development of the <tt class="docutils literal"><span class="pre">--gc:arc</span></tt> mode.</li>
</ul>

</div>
<div class="slide">
<h1 id="arc">ARC</h1><table class="line-nums-table"><tbody><tr><td class="blob-line-nums"><pre class="line-nums">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td><pre id="listing_19" class="listing"><span class="Keyword">include</span> <span class="Identifier">prelude</span>

<span class="Keyword">type</span>
  <span class="Identifier">Node</span> <span class="Operator">=</span> <span class="Keyword">ref</span> <span class="Keyword">object</span>
    <span class="Identifier">le</span><span class="Punctuation">,</span> <span class="Identifier">ri</span><span class="Punctuation">:</span> <span class="Identifier">Node</span>

<span class="Keyword">proc</span> <span class="Identifier">checkTree</span><span class="Punctuation">(</span><span class="Identifier">n</span><span class="Punctuation">:</span> <span class="Identifier">Node</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">int</span> <span class="Operator">=</span>
  <span class="Keyword">if</span> <span class="Identifier">n</span><span class="Operator">.</span><span class="Identifier">le</span> <span class="Operator">==</span> <span class="Keyword">nil</span><span class="Punctuation">:</span> <span class="DecNumber">1</span>
  <span class="Keyword">else</span><span class="Punctuation">:</span> <span class="DecNumber">1</span> <span class="Operator">+</span> <span class="Identifier">checkTree</span><span class="Punctuation">(</span><span class="Identifier">n</span><span class="Operator">.</span><span class="Identifier">le</span><span class="Punctuation">)</span> <span class="Operator">+</span> <span class="Identifier">checkTree</span><span class="Punctuation">(</span><span class="Identifier">n</span><span class="Operator">.</span><span class="Identifier">ri</span><span class="Punctuation">)</span>

<span class="Keyword">proc</span> <span class="Identifier">makeTree</span><span class="Punctuation">(</span><span class="Identifier">depth</span><span class="Punctuation">:</span> <span class="Identifier">int</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">Node</span> <span class="Operator">=</span>
  <span class="Keyword">if</span> <span class="Identifier">depth</span> <span class="Operator">==</span> <span class="DecNumber">0</span><span class="Punctuation">:</span> <span class="Identifier">Node</span><span class="Punctuation">(</span><span class="Identifier">le</span><span class="Punctuation">:</span> <span class="Keyword">nil</span><span class="Punctuation">,</span> <span class="Identifier">ri</span><span class="Punctuation">:</span> <span class="Keyword">nil</span><span class="Punctuation">)</span>
  <span class="Keyword">else</span><span class="Punctuation">:</span> <span class="Identifier">Node</span><span class="Punctuation">(</span><span class="Identifier">le</span><span class="Punctuation">:</span> <span class="Identifier">makeTree</span><span class="Punctuation">(</span><span class="Identifier">depth</span><span class="Operator">-</span><span class="DecNumber">1</span><span class="Punctuation">)</span><span class="Punctuation">,</span> <span class="Identifier">ri</span><span class="Punctuation">:</span> <span class="Identifier">makeTree</span><span class="Punctuation">(</span><span class="Identifier">depth</span><span class="Operator">-</span><span class="DecNumber">1</span><span class="Punctuation">)</span><span class="Punctuation">)</span></pre></td></tr></tbody></table>
</div>
<div class="slide">
<h1 id="arc-2">ARC (2)</h1><table class="line-nums-table"><tbody><tr><td class="blob-line-nums"><pre class="line-nums">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td><pre id="listing_20" class="listing"><span class="Keyword">proc</span> <span class="Identifier">main</span> <span class="Operator">=</span>
  <span class="Keyword">let</span> <span class="Identifier">maxDepth</span> <span class="Operator">=</span> <span class="Identifier">parseInt</span><span class="Punctuation">(</span><span class="Identifier">paramStr</span><span class="Punctuation">(</span><span class="DecNumber">1</span><span class="Punctuation">)</span><span class="Punctuation">)</span>
  <span class="Keyword">const</span> <span class="Identifier">minDepth</span> <span class="Operator">=</span> <span class="DecNumber">4</span>
  <span class="Keyword">let</span> <span class="Identifier">stretchDepth</span> <span class="Operator">=</span> <span class="Identifier">maxDepth</span> <span class="Operator">+</span> <span class="DecNumber">1</span>
  <span class="Identifier">echo</span><span class="Punctuation">(</span><span class="StringLit">&quot;stretch tree of depth &quot;</span><span class="Punctuation">,</span> <span class="Identifier">stretchDepth</span><span class="Punctuation">,</span> <span class="StringLit">&quot;</span><span class="EscapeSequence">\t</span><span class="StringLit"> check:&quot;</span><span class="Punctuation">,</span>
    <span class="Identifier">checkTree</span> <span class="Identifier">makeTree</span><span class="Punctuation">(</span><span class="Identifier">stretchDepth</span><span class="Punctuation">)</span><span class="Punctuation">)</span>
  <span class="Keyword">let</span> <span class="Identifier">longLivedTree</span> <span class="Operator">=</span> <span class="Identifier">makeTree</span><span class="Punctuation">(</span><span class="Identifier">maxDepth</span><span class="Punctuation">)</span>
  <span class="Keyword">var</span> <span class="Identifier">iterations</span> <span class="Operator">=</span> <span class="DecNumber">1</span> <span class="Keyword">shl</span> <span class="Identifier">maxDepth</span>
  <span class="Keyword">for</span> <span class="Identifier">depth</span> <span class="Keyword">in</span> <span class="Identifier">countup</span><span class="Punctuation">(</span><span class="Identifier">minDepth</span><span class="Punctuation">,</span> <span class="Identifier">maxDepth</span><span class="Punctuation">,</span> <span class="DecNumber">2</span><span class="Punctuation">)</span><span class="Punctuation">:</span>
    <span class="Keyword">var</span> <span class="Identifier">check</span> <span class="Operator">=</span> <span class="DecNumber">0</span>
    <span class="Keyword">for</span> <span class="Identifier">i</span> <span class="Keyword">in</span> <span class="FloatNumber">1.</span><span class="Operator">.</span><span class="Identifier">iterations</span><span class="Punctuation">:</span>
      <span class="Identifier">check</span> <span class="Operator">+=</span> <span class="Identifier">checkTree</span><span class="Punctuation">(</span><span class="Identifier">makeTree</span><span class="Punctuation">(</span><span class="Identifier">depth</span><span class="Punctuation">)</span><span class="Punctuation">)</span>
    <span class="Identifier">echo</span> <span class="Identifier">iterations</span><span class="Punctuation">,</span> <span class="StringLit">&quot;</span><span class="EscapeSequence">\t</span><span class="StringLit"> trees of depth &quot;</span><span class="Punctuation">,</span> <span class="Identifier">depth</span><span class="Punctuation">,</span> <span class="StringLit">&quot;</span><span class="EscapeSequence">\t</span><span class="StringLit"> check:&quot;</span><span class="Punctuation">,</span> <span class="Identifier">check</span>
    <span class="Identifier">iterations</span> <span class="Operator">=</span> <span class="Identifier">iterations</span> <span class="Keyword">div</span> <span class="DecNumber">4</span>

<span class="Identifier">main</span><span class="Punctuation">(</span><span class="Punctuation">)</span></pre></td></tr></tbody></table>
</div>
<div class="slide">
<h1 id="manual-memory-management">Manual memory management</h1><table class="line-nums-table"><tbody><tr><td class="blob-line-nums"><pre class="line-nums">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td><pre id="listing_21" class="listing"><span class="Keyword">include</span> <span class="Identifier">prelude</span>

<span class="Keyword">type</span>
  <span class="Identifier">Node</span> <span class="Operator">=</span> <span class="Keyword">ptr</span> <span class="Keyword">object</span>
    <span class="Identifier">le</span><span class="Punctuation">,</span> <span class="Identifier">ri</span><span class="Punctuation">:</span> <span class="Identifier">Node</span>

<span class="Keyword">proc</span> <span class="Identifier">checkTree</span><span class="Punctuation">(</span><span class="Identifier">n</span><span class="Punctuation">:</span> <span class="Identifier">Node</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">int</span> <span class="Operator">=</span>
  <span class="Keyword">if</span> <span class="Identifier">n</span><span class="Operator">.</span><span class="Identifier">le</span> <span class="Operator">==</span> <span class="Keyword">nil</span><span class="Punctuation">:</span> <span class="DecNumber">1</span>
  <span class="Keyword">else</span><span class="Punctuation">:</span> <span class="DecNumber">1</span> <span class="Operator">+</span> <span class="Identifier">checkTree</span><span class="Punctuation">(</span><span class="Identifier">n</span><span class="Operator">.</span><span class="Identifier">le</span><span class="Punctuation">)</span> <span class="Operator">+</span> <span class="Identifier">checkTree</span><span class="Punctuation">(</span><span class="Identifier">n</span><span class="Operator">.</span><span class="Identifier">ri</span><span class="Punctuation">)</span>

<span class="Keyword">proc</span> <span class="Identifier">makeTree</span><span class="Punctuation">(</span><span class="Identifier">depth</span><span class="Punctuation">:</span> <span class="Identifier">int</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">Node</span> <span class="Operator">=</span>
  <span class="Identifier">result</span> <span class="Operator">=</span> <span class="Keyword">cast</span><span class="Punctuation">[</span><span class="Identifier">Node</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="Identifier">alloc</span><span class="Punctuation">(</span><span class="Identifier">sizeof</span><span class="Punctuation">(</span><span class="Identifier">result</span><span class="Punctuation">[</span><span class="Punctuation">]</span><span class="Punctuation">)</span><span class="Punctuation">)</span><span class="Punctuation">)</span>
  <span class="Keyword">if</span> <span class="Identifier">depth</span> <span class="Operator">==</span> <span class="DecNumber">0</span><span class="Punctuation">:</span>
    <span class="Identifier">result</span><span class="Operator">.</span><span class="Identifier">le</span> <span class="Operator">=</span> <span class="Keyword">nil</span><span class="Punctuation">;</span> <span class="Identifier">result</span><span class="Operator">.</span><span class="Identifier">ri</span> <span class="Operator">=</span> <span class="Keyword">nil</span>
  <span class="Keyword">else</span><span class="Punctuation">:</span>
    <span class="Identifier">result</span><span class="Operator">.</span><span class="Identifier">le</span> <span class="Operator">=</span> <span class="Identifier">makeTree</span><span class="Punctuation">(</span><span class="Identifier">depth</span><span class="Operator">-</span><span class="DecNumber">1</span><span class="Punctuation">)</span>
    <span class="Identifier">result</span><span class="Operator">.</span><span class="Identifier">ri</span> <span class="Operator">=</span> <span class="Identifier">makeTree</span><span class="Punctuation">(</span><span class="Identifier">depth</span><span class="Operator">-</span><span class="DecNumber">1</span><span class="Punctuation">)</span>

<span class="Keyword">proc</span> <span class="Identifier">freeTree</span><span class="Punctuation">(</span><span class="Identifier">n</span><span class="Punctuation">:</span> <span class="Identifier">Node</span><span class="Punctuation">)</span> <span class="Operator">=</span>
  <span class="Keyword">if</span> <span class="Identifier">n</span> <span class="Operator">!=</span> <span class="Keyword">nil</span><span class="Punctuation">:</span>
    <span class="Identifier">freeTree</span><span class="Punctuation">(</span><span class="Identifier">n</span><span class="Operator">.</span><span class="Identifier">le</span><span class="Punctuation">)</span>
    <span class="Identifier">freeTree</span><span class="Punctuation">(</span><span class="Identifier">n</span><span class="Operator">.</span><span class="Identifier">ri</span><span class="Punctuation">)</span>
    <span class="Identifier">dealloc</span><span class="Punctuation">(</span><span class="Identifier">n</span><span class="Punctuation">)</span></pre></td></tr></tbody></table>
</div>
<div class="slide">
<h1 id="manual-memory-management-2">Manual memory management (2)</h1><table class="line-nums-table"><tbody><tr><td class="blob-line-nums"><pre class="line-nums">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td><pre id="listing_22" class="listing"><span class="Keyword">proc</span> <span class="Identifier">main</span> <span class="Operator">=</span>
  <span class="Keyword">let</span> <span class="Identifier">maxDepth</span> <span class="Operator">=</span> <span class="Identifier">parseInt</span><span class="Punctuation">(</span><span class="Identifier">paramStr</span><span class="Punctuation">(</span><span class="DecNumber">1</span><span class="Punctuation">)</span><span class="Punctuation">)</span>
  <span class="Keyword">const</span> <span class="Identifier">minDepth</span> <span class="Operator">=</span> <span class="DecNumber">4</span>
  <span class="Keyword">let</span> <span class="Identifier">stretchDepth</span> <span class="Operator">=</span> <span class="Identifier">maxDepth</span> <span class="Operator">+</span> <span class="DecNumber">1</span>
  <span class="Keyword">let</span> <span class="Identifier">stree</span> <span class="Operator">=</span> <span class="Identifier">makeTree</span><span class="Punctuation">(</span><span class="Identifier">stretchDepth</span><span class="Punctuation">)</span>
  <span class="Identifier">echo</span><span class="Punctuation">(</span><span class="StringLit">&quot;stretch tree of depth &quot;</span><span class="Punctuation">,</span> <span class="Identifier">stretchDepth</span><span class="Punctuation">,</span> <span class="StringLit">&quot;</span><span class="EscapeSequence">\t</span><span class="StringLit"> check:&quot;</span><span class="Punctuation">,</span>
    <span class="Identifier">checkTree</span> <span class="Identifier">stree</span><span class="Punctuation">)</span>
  <span class="Keyword">let</span> <span class="Identifier">longLivedTree</span> <span class="Operator">=</span> <span class="Identifier">makeTree</span><span class="Punctuation">(</span><span class="Identifier">maxDepth</span><span class="Punctuation">)</span>
  <span class="Keyword">var</span> <span class="Identifier">iterations</span> <span class="Operator">=</span> <span class="DecNumber">1</span> <span class="Keyword">shl</span> <span class="Identifier">maxDepth</span>
  <span class="Keyword">for</span> <span class="Identifier">depth</span> <span class="Keyword">in</span> <span class="Identifier">countup</span><span class="Punctuation">(</span><span class="Identifier">minDepth</span><span class="Punctuation">,</span> <span class="Identifier">maxDepth</span><span class="Punctuation">,</span> <span class="DecNumber">2</span><span class="Punctuation">)</span><span class="Punctuation">:</span>
    <span class="Keyword">var</span> <span class="Identifier">check</span> <span class="Operator">=</span> <span class="DecNumber">0</span>
    <span class="Keyword">for</span> <span class="Identifier">i</span> <span class="Keyword">in</span> <span class="FloatNumber">1.</span><span class="Operator">.</span><span class="Identifier">iterations</span><span class="Punctuation">:</span>
      <span class="Keyword">let</span> <span class="Identifier">tmp</span> <span class="Operator">=</span> <span class="Identifier">makeTree</span><span class="Punctuation">(</span><span class="Identifier">depth</span><span class="Punctuation">)</span>
      <span class="Identifier">check</span> <span class="Operator">+=</span> <span class="Identifier">checkTree</span><span class="Punctuation">(</span><span class="Identifier">tmp</span><span class="Punctuation">)</span>
      <span class="Identifier">freeTree</span><span class="Punctuation">(</span><span class="Identifier">tmp</span><span class="Punctuation">)</span>
    <span class="Identifier">echo</span> <span class="Identifier">iterations</span><span class="Punctuation">,</span> <span class="StringLit">&quot;</span><span class="EscapeSequence">\t</span><span class="StringLit"> trees of depth &quot;</span><span class="Punctuation">,</span> <span class="Identifier">depth</span><span class="Punctuation">,</span> <span class="StringLit">&quot;</span><span class="EscapeSequence">\t</span><span class="StringLit"> check:&quot;</span><span class="Punctuation">,</span> <span class="Identifier">check</span>
    <span class="Identifier">iterations</span> <span class="Operator">=</span> <span class="Identifier">iterations</span> <span class="Keyword">div</span> <span class="DecNumber">4</span>
  <span class="Identifier">freeTree</span><span class="Punctuation">(</span><span class="Identifier">longLivedTree</span><span class="Punctuation">)</span>
  <span class="Identifier">freeTree</span><span class="Punctuation">(</span><span class="Identifier">stree</span><span class="Punctuation">)</span>

<span class="Identifier">main</span><span class="Punctuation">(</span><span class="Punctuation">)</span></pre></td></tr></tbody></table>
</div>
<div class="slide">
<h1 id="benchmarkcolon-throughput">Benchmark: Throughput</h1><table border="1" class="docutils"><tr><th>Memory management strategy</th><th>Time</th><th>Peak Memory</th></tr>
<tr><td>mark&amp;sweep GC</td><td>17s</td><td>588.047MiB</td></tr>
<tr><td>deferred refcounting GC</td><td>16s</td><td>304.074MiB</td></tr>
<tr><td>Boehm GC</td><td>12s</td><td>N/A</td></tr>
<tr><td>ARC</td><td><strong>7.8s</strong></td><td>740.715MiB</td></tr>
<tr><td>manual memory management</td><td>6.75s</td><td>473.195MiB</td></tr>
</table>
</div>
<div class="slide">
<h1 id="benchmarkcolon-latency">Benchmark: Latency</h1><table border="1" class="docutils"><tr><th>Memory management strategy</th><th>Latency</th><th>Total  Time</th><th>Peak Memory</th></tr>
<tr><td>deferred refcounting GC</td><td>0.0356ms</td><td>0.314s</td><td>300MiB</td></tr>
<tr><td>ARC</td><td>0.0106ms</td><td>0.254s</td><td>271MiB</td></tr>
</table>
</div>
<div class="slide">
<h1 id="custom-containers">Custom containers</h1><ul class="simple"><li>Custom destructors, assignments and move optimizations.</li>
<li>Files/sockets etc can be closed automatically. (See C++, Rust.)</li>
<li>Enable composition between specialized memory management solutions.</li>
</ul>

</div>
<div class="slide">
<h1 id="destructors">Destructors</h1><table class="line-nums-table"><tbody><tr><td class="blob-line-nums"><pre class="line-nums">1
2
3
4
5
6
7
8
9
10
</pre></td><td><pre id="listing_23" class="listing"><span class="Keyword">type</span>
  <span class="Identifier">myseq</span><span class="Operator">*</span><span class="Punctuation">[</span><span class="Identifier">T</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="Keyword">object</span>
    <span class="Identifier">len</span><span class="Punctuation">,</span> <span class="Identifier">cap</span><span class="Punctuation">:</span> <span class="Identifier">int</span>
    <span class="Identifier">data</span><span class="Punctuation">:</span> <span class="Keyword">ptr</span> <span class="Identifier">UncheckedArray</span><span class="Punctuation">[</span><span class="Identifier">T</span><span class="Punctuation">]</span>

<span class="Keyword">proc</span> <span class="Punctuation">`</span><span class="Operator">=</span><span class="Identifier">destroy</span><span class="Punctuation">`</span><span class="Operator">*</span><span class="Punctuation">[</span><span class="Identifier">T</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="Identifier">x</span><span class="Punctuation">:</span> <span class="Keyword">var</span> <span class="Identifier">myseq</span><span class="Punctuation">[</span><span class="Identifier">T</span><span class="Punctuation">]</span><span class="Punctuation">)</span> <span class="Operator">=</span>
  <span class="Keyword">if</span> <span class="Identifier">x</span><span class="Operator">.</span><span class="Identifier">data</span> <span class="Operator">!=</span> <span class="Keyword">nil</span><span class="Punctuation">:</span>
    <span class="Keyword">for</span> <span class="Identifier">i</span> <span class="Keyword">in</span> <span class="FloatNumber">0.</span><span class="Operator">.&lt;</span><span class="Identifier">x</span><span class="Operator">.</span><span class="Identifier">len</span><span class="Punctuation">:</span> <span class="Punctuation">`</span><span class="Operator">=</span><span class="Identifier">destroy</span><span class="Punctuation">`</span><span class="Punctuation">(</span><span class="Identifier">x</span><span class="Punctuation">[</span><span class="Identifier">i</span><span class="Punctuation">]</span><span class="Punctuation">)</span>
    <span class="Identifier">dealloc</span><span class="Punctuation">(</span><span class="Identifier">x</span><span class="Operator">.</span><span class="Identifier">data</span><span class="Punctuation">)</span>
    <span class="Identifier">x</span><span class="Operator">.</span><span class="Identifier">data</span> <span class="Operator">=</span> <span class="Keyword">nil</span></pre></td></tr></tbody></table>
</div>
<div class="slide">
<h1 id="assignment-operator">Assignment operator</h1><table class="line-nums-table"><tbody><tr><td class="blob-line-nums"><pre class="line-nums">1
2
3
4
5
6
7
8
9
10
</pre></td><td><pre id="listing_24" class="listing"><span class="Keyword">proc</span> <span class="Punctuation">`</span><span class="Operator">=</span><span class="Punctuation">`</span><span class="Operator">*</span><span class="Punctuation">[</span><span class="Identifier">T</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="Identifier">a</span><span class="Punctuation">:</span> <span class="Keyword">var</span> <span class="Identifier">myseq</span><span class="Punctuation">[</span><span class="Identifier">T</span><span class="Punctuation">]</span><span class="Punctuation">;</span> <span class="Identifier">b</span><span class="Punctuation">:</span> <span class="Identifier">myseq</span><span class="Punctuation">[</span><span class="Identifier">T</span><span class="Punctuation">]</span><span class="Punctuation">)</span> <span class="Operator">=</span>
  <span class="Comment"># do nothing for self-assignments:</span>
  <span class="Keyword">if</span> <span class="Identifier">a</span><span class="Operator">.</span><span class="Identifier">data</span> <span class="Operator">==</span> <span class="Identifier">b</span><span class="Operator">.</span><span class="Identifier">data</span><span class="Punctuation">:</span> <span class="Keyword">return</span>
  <span class="Punctuation">`</span><span class="Operator">=</span><span class="Identifier">destroy</span><span class="Punctuation">`</span><span class="Punctuation">(</span><span class="Identifier">a</span><span class="Punctuation">)</span>
  <span class="Identifier">a</span><span class="Operator">.</span><span class="Identifier">len</span> <span class="Operator">=</span> <span class="Identifier">b</span><span class="Operator">.</span><span class="Identifier">len</span>
  <span class="Identifier">a</span><span class="Operator">.</span><span class="Identifier">cap</span> <span class="Operator">=</span> <span class="Identifier">b</span><span class="Operator">.</span><span class="Identifier">cap</span>
  <span class="Keyword">if</span> <span class="Identifier">b</span><span class="Operator">.</span><span class="Identifier">data</span> <span class="Operator">!=</span> <span class="Keyword">nil</span><span class="Punctuation">:</span>
    <span class="Identifier">a</span><span class="Operator">.</span><span class="Identifier">data</span> <span class="Operator">=</span> <span class="Keyword">cast</span><span class="Punctuation">[</span><span class="Keyword">type</span><span class="Punctuation">(</span><span class="Identifier">a</span><span class="Operator">.</span><span class="Identifier">data</span><span class="Punctuation">)</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="Identifier">alloc</span><span class="Punctuation">(</span><span class="Identifier">a</span><span class="Operator">.</span><span class="Identifier">cap</span> <span class="Operator">*</span> <span class="Identifier">sizeof</span><span class="Punctuation">(</span><span class="Identifier">T</span><span class="Punctuation">)</span><span class="Punctuation">)</span><span class="Punctuation">)</span>
    <span class="Keyword">for</span> <span class="Identifier">i</span> <span class="Keyword">in</span> <span class="FloatNumber">0.</span><span class="Operator">.&lt;</span><span class="Identifier">a</span><span class="Operator">.</span><span class="Identifier">len</span><span class="Punctuation">:</span>
      <span class="Identifier">a</span><span class="Operator">.</span><span class="Identifier">data</span><span class="Punctuation">[</span><span class="Identifier">i</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="Identifier">b</span><span class="Operator">.</span><span class="Identifier">data</span><span class="Punctuation">[</span><span class="Identifier">i</span><span class="Punctuation">]</span></pre></td></tr></tbody></table>
</div>
<div class="slide">
<h1 id="move-operator">Move operator</h1><table class="line-nums-table"><tbody><tr><td class="blob-line-nums"><pre class="line-nums">1
2
3
4
5
6
7
</pre></td><td><pre id="listing_25" class="listing"><span class="Keyword">proc</span> <span class="Punctuation">`</span><span class="Operator">=</span><span class="Identifier">sink</span><span class="Punctuation">`</span><span class="Operator">*</span><span class="Punctuation">[</span><span class="Identifier">T</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="Identifier">a</span><span class="Punctuation">:</span> <span class="Keyword">var</span> <span class="Identifier">myseq</span><span class="Punctuation">[</span><span class="Identifier">T</span><span class="Punctuation">]</span><span class="Punctuation">;</span> <span class="Identifier">b</span><span class="Punctuation">:</span> <span class="Identifier">myseq</span><span class="Punctuation">[</span><span class="Identifier">T</span><span class="Punctuation">]</span><span class="Punctuation">)</span> <span class="Operator">=</span>
  <span class="Comment"># move assignment, optional.</span>
  <span class="Comment"># Compiler is using `=destroy` and `copyMem` when not provided</span>
  <span class="Punctuation">`</span><span class="Operator">=</span><span class="Identifier">destroy</span><span class="Punctuation">`</span><span class="Punctuation">(</span><span class="Identifier">a</span><span class="Punctuation">)</span>
  <span class="Identifier">a</span><span class="Operator">.</span><span class="Identifier">len</span> <span class="Operator">=</span> <span class="Identifier">b</span><span class="Operator">.</span><span class="Identifier">len</span>
  <span class="Identifier">a</span><span class="Operator">.</span><span class="Identifier">cap</span> <span class="Operator">=</span> <span class="Identifier">b</span><span class="Operator">.</span><span class="Identifier">cap</span>
  <span class="Identifier">a</span><span class="Operator">.</span><span class="Identifier">data</span> <span class="Operator">=</span> <span class="Identifier">b</span><span class="Operator">.</span><span class="Identifier">data</span></pre></td></tr></tbody></table>
</div>
<div class="slide">
<h1 id="accessors">Accessors</h1><table class="line-nums-table"><tbody><tr><td class="blob-line-nums"><pre class="line-nums">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td><pre id="listing_26" class="listing"><span class="Keyword">proc</span> <span class="Identifier">add</span><span class="Operator">*</span><span class="Punctuation">[</span><span class="Identifier">T</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="Identifier">x</span><span class="Punctuation">:</span> <span class="Keyword">var</span> <span class="Identifier">myseq</span><span class="Punctuation">[</span><span class="Identifier">T</span><span class="Punctuation">]</span><span class="Punctuation">;</span> <span class="Identifier">y</span><span class="Punctuation">:</span> <span class="Identifier">sink</span> <span class="Identifier">T</span><span class="Punctuation">)</span> <span class="Operator">=</span>
  <span class="Keyword">if</span> <span class="Identifier">x</span><span class="Operator">.</span><span class="Identifier">len</span> <span class="Operator">&gt;=</span> <span class="Identifier">x</span><span class="Operator">.</span><span class="Identifier">cap</span><span class="Punctuation">:</span> <span class="Identifier">resize</span><span class="Punctuation">(</span><span class="Identifier">x</span><span class="Punctuation">)</span>
  <span class="Identifier">x</span><span class="Operator">.</span><span class="Identifier">data</span><span class="Punctuation">[</span><span class="Identifier">x</span><span class="Operator">.</span><span class="Identifier">len</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="Identifier">y</span>
  <span class="Identifier">inc</span> <span class="Identifier">x</span><span class="Operator">.</span><span class="Identifier">len</span>

<span class="Keyword">proc</span> <span class="Punctuation">`</span><span class="Punctuation">[</span><span class="Punctuation">]</span><span class="Punctuation">`</span><span class="Operator">*</span><span class="Punctuation">[</span><span class="Identifier">T</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="Identifier">x</span><span class="Punctuation">:</span> <span class="Identifier">myseq</span><span class="Punctuation">[</span><span class="Identifier">T</span><span class="Punctuation">]</span><span class="Punctuation">;</span> <span class="Identifier">i</span><span class="Punctuation">:</span> <span class="Identifier">Natural</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">lent</span> <span class="Identifier">T</span> <span class="Operator">=</span>
  <span class="Identifier">assert</span> <span class="Identifier">i</span> <span class="Operator">&lt;</span> <span class="Identifier">x</span><span class="Operator">.</span><span class="Identifier">len</span>
  <span class="Identifier">x</span><span class="Operator">.</span><span class="Identifier">data</span><span class="Punctuation">[</span><span class="Identifier">i</span><span class="Punctuation">]</span>

<span class="Keyword">proc</span> <span class="Punctuation">`</span><span class="Punctuation">[</span><span class="Punctuation">]</span><span class="Operator">=</span><span class="Punctuation">`</span><span class="Operator">*</span><span class="Punctuation">[</span><span class="Identifier">T</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="Identifier">x</span><span class="Punctuation">:</span> <span class="Keyword">var</span> <span class="Identifier">myseq</span><span class="Punctuation">[</span><span class="Identifier">T</span><span class="Punctuation">]</span><span class="Punctuation">;</span> <span class="Identifier">i</span><span class="Punctuation">:</span> <span class="Identifier">Natural</span><span class="Punctuation">;</span> <span class="Identifier">y</span><span class="Punctuation">:</span> <span class="Identifier">sink</span> <span class="Identifier">T</span><span class="Punctuation">)</span> <span class="Operator">=</span>
  <span class="Identifier">assert</span> <span class="Identifier">i</span> <span class="Operator">&lt;</span> <span class="Identifier">x</span><span class="Operator">.</span><span class="Identifier">len</span>
  <span class="Identifier">x</span><span class="Operator">.</span><span class="Identifier">data</span><span class="Punctuation">[</span><span class="Identifier">i</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="Identifier">y</span></pre></td></tr></tbody></table>
</div>
<div class="slide">
<h1 id="object-pooling">Object pooling</h1><table class="line-nums-table"><tbody><tr><td class="blob-line-nums"><pre class="line-nums">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td><pre id="listing_27" class="listing"><span class="Keyword">include</span> <span class="Identifier">prelude</span>

<span class="Keyword">type</span>
  <span class="Identifier">NodeObj</span> <span class="Operator">=</span> <span class="Keyword">object</span>
    <span class="Identifier">le</span><span class="Punctuation">,</span> <span class="Identifier">ri</span><span class="Punctuation">:</span> <span class="Identifier">Node</span>
  <span class="Identifier">Node</span> <span class="Operator">=</span> <span class="Keyword">ptr</span> <span class="Identifier">NodeObj</span>
  
  <span class="Identifier">PoolNode</span> <span class="Operator">=</span> <span class="Keyword">object</span>
    <span class="Identifier">next</span><span class="Punctuation">:</span> <span class="Keyword">ptr</span> <span class="Identifier">PoolNode</span>
    <span class="Identifier">elems</span><span class="Punctuation">:</span> <span class="Identifier">UncheckedArray</span><span class="Punctuation">[</span><span class="Identifier">NodeObj</span><span class="Punctuation">]</span>
  
  <span class="Identifier">Pool</span> <span class="Operator">=</span> <span class="Keyword">object</span>
    <span class="Identifier">len</span><span class="Punctuation">:</span> <span class="Identifier">int</span>
    <span class="Identifier">last</span><span class="Punctuation">:</span> <span class="Keyword">ptr</span> <span class="Identifier">PoolNode</span>
    <span class="Identifier">lastCap</span><span class="Punctuation">:</span> <span class="Identifier">int</span></pre></td></tr></tbody></table>
</div>
<div class="slide">
<h1 id="object-pooling-2">Object pooling (2)</h1><table class="line-nums-table"><tbody><tr><td class="blob-line-nums"><pre class="line-nums">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td><pre id="listing_28" class="listing"><span class="Keyword">proc</span> <span class="Punctuation">`</span><span class="Operator">=</span><span class="Punctuation">`</span><span class="Punctuation">(</span><span class="Identifier">dest</span><span class="Punctuation">:</span> <span class="Keyword">var</span> <span class="Identifier">Pool</span><span class="Punctuation">;</span> <span class="Identifier">src</span><span class="Punctuation">:</span> <span class="Identifier">Pool</span><span class="Punctuation">)</span> <span class="Punctuation">{</span><span class="Operator">.</span><span class="Identifier">error</span><span class="Operator">.</span><span class="Punctuation">}</span>

<span class="Keyword">proc</span> <span class="Punctuation">`</span><span class="Operator">=</span><span class="Identifier">destroy</span><span class="Punctuation">`</span><span class="Punctuation">(</span><span class="Identifier">p</span><span class="Punctuation">:</span> <span class="Keyword">var</span> <span class="Identifier">Pool</span><span class="Punctuation">)</span> <span class="Operator">=</span>
  <span class="Keyword">var</span> <span class="Identifier">it</span> <span class="Operator">=</span> <span class="Identifier">p</span><span class="Operator">.</span><span class="Identifier">last</span>
  <span class="Keyword">while</span> <span class="Identifier">it</span> <span class="Operator">!=</span> <span class="Keyword">nil</span><span class="Punctuation">:</span>
    <span class="Keyword">let</span> <span class="Identifier">next</span> <span class="Operator">=</span> <span class="Identifier">it</span><span class="Operator">.</span><span class="Identifier">next</span>
    <span class="Identifier">dealloc</span><span class="Punctuation">(</span><span class="Identifier">it</span><span class="Punctuation">)</span>
    <span class="Identifier">it</span> <span class="Operator">=</span> <span class="Identifier">next</span>
  <span class="Identifier">p</span><span class="Operator">.</span><span class="Identifier">len</span> <span class="Operator">=</span> <span class="DecNumber">0</span>
  <span class="Identifier">p</span><span class="Operator">.</span><span class="Identifier">lastCap</span> <span class="Operator">=</span> <span class="DecNumber">0</span>
  <span class="Identifier">p</span><span class="Operator">.</span><span class="Identifier">last</span> <span class="Operator">=</span> <span class="Keyword">nil</span></pre></td></tr></tbody></table>
</div>
<div class="slide">
<h1 id="object-pooling-3">Object pooling (3)</h1><table class="line-nums-table"><tbody><tr><td class="blob-line-nums"><pre class="line-nums">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td><pre id="listing_29" class="listing"><span class="Keyword">proc</span> <span class="Identifier">newNode</span><span class="Punctuation">(</span><span class="Identifier">p</span><span class="Punctuation">:</span> <span class="Keyword">var</span> <span class="Identifier">Pool</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">Node</span> <span class="Operator">=</span>
  <span class="Keyword">if</span> <span class="Identifier">p</span><span class="Operator">.</span><span class="Identifier">len</span> <span class="Operator">&gt;=</span> <span class="Identifier">p</span><span class="Operator">.</span><span class="Identifier">lastCap</span><span class="Punctuation">:</span>
    <span class="Keyword">if</span> <span class="Identifier">p</span><span class="Operator">.</span><span class="Identifier">lastCap</span> <span class="Operator">==</span> <span class="DecNumber">0</span><span class="Punctuation">:</span> <span class="Identifier">p</span><span class="Operator">.</span><span class="Identifier">lastCap</span> <span class="Operator">=</span> <span class="DecNumber">4</span>
    <span class="Keyword">elif</span> <span class="Identifier">p</span><span class="Operator">.</span><span class="Identifier">lastCap</span> <span class="Operator">&lt;</span> <span class="DecNumber">65_000</span><span class="Punctuation">:</span> <span class="Identifier">p</span><span class="Operator">.</span><span class="Identifier">lastCap</span> <span class="Operator">*=</span> <span class="DecNumber">2</span>
    <span class="Keyword">var</span> <span class="Identifier">n</span> <span class="Operator">=</span> <span class="Keyword">cast</span><span class="Punctuation">[</span><span class="Keyword">ptr</span> <span class="Identifier">PoolNode</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="Identifier">alloc</span><span class="Punctuation">(</span><span class="Identifier">sizeof</span><span class="Punctuation">(</span><span class="Identifier">PoolNode</span><span class="Punctuation">)</span> <span class="Operator">+</span> <span class="Identifier">p</span><span class="Operator">.</span><span class="Identifier">lastCap</span> <span class="Operator">*</span> <span class="Identifier">sizeof</span><span class="Punctuation">(</span><span class="Identifier">NodeObj</span><span class="Punctuation">)</span><span class="Punctuation">)</span><span class="Punctuation">)</span>
    <span class="Identifier">n</span><span class="Operator">.</span><span class="Identifier">next</span> <span class="Operator">=</span> <span class="Keyword">nil</span>
    <span class="Identifier">n</span><span class="Operator">.</span><span class="Identifier">next</span> <span class="Operator">=</span> <span class="Identifier">p</span><span class="Operator">.</span><span class="Identifier">last</span>
    <span class="Identifier">p</span><span class="Operator">.</span><span class="Identifier">last</span> <span class="Operator">=</span> <span class="Identifier">n</span>
    <span class="Identifier">p</span><span class="Operator">.</span><span class="Identifier">len</span> <span class="Operator">=</span> <span class="DecNumber">0</span>
  <span class="Identifier">result</span> <span class="Operator">=</span> <span class="Keyword">addr</span><span class="Punctuation">(</span><span class="Identifier">p</span><span class="Operator">.</span><span class="Identifier">last</span><span class="Operator">.</span><span class="Identifier">elems</span><span class="Punctuation">[</span><span class="Identifier">p</span><span class="Operator">.</span><span class="Identifier">len</span><span class="Punctuation">]</span><span class="Punctuation">)</span>
  <span class="Identifier">inc</span> <span class="Identifier">p</span><span class="Operator">.</span><span class="Identifier">len</span></pre></td></tr></tbody></table>
</div>
<div class="slide">
<h1 id="object-pooling-4">Object pooling (4)</h1><table class="line-nums-table"><tbody><tr><td class="blob-line-nums"><pre class="line-nums">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td><pre id="listing_30" class="listing"><span class="Keyword">proc</span> <span class="Identifier">checkTree</span><span class="Punctuation">(</span><span class="Identifier">n</span><span class="Punctuation">:</span> <span class="Identifier">Node</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">int</span> <span class="Operator">=</span>
  <span class="Keyword">if</span> <span class="Identifier">n</span><span class="Operator">.</span><span class="Identifier">le</span> <span class="Operator">==</span> <span class="Keyword">nil</span><span class="Punctuation">:</span> <span class="DecNumber">1</span>
  <span class="Keyword">else</span><span class="Punctuation">:</span> <span class="DecNumber">1</span> <span class="Operator">+</span> <span class="Identifier">checkTree</span><span class="Punctuation">(</span><span class="Identifier">n</span><span class="Operator">.</span><span class="Identifier">le</span><span class="Punctuation">)</span> <span class="Operator">+</span> <span class="Identifier">checkTree</span><span class="Punctuation">(</span><span class="Identifier">n</span><span class="Operator">.</span><span class="Identifier">ri</span><span class="Punctuation">)</span>

<span class="Keyword">proc</span> <span class="Identifier">makeTree</span><span class="Punctuation">(</span><span class="Identifier">p</span><span class="Punctuation">:</span> <span class="Keyword">var</span> <span class="Identifier">Pool</span><span class="Punctuation">;</span> <span class="Identifier">depth</span><span class="Punctuation">:</span> <span class="Identifier">int</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">Node</span> <span class="Operator">=</span>
  <span class="Identifier">result</span> <span class="Operator">=</span> <span class="Identifier">newNode</span><span class="Punctuation">(</span><span class="Identifier">p</span><span class="Punctuation">)</span>
  <span class="Keyword">if</span> <span class="Identifier">depth</span> <span class="Operator">==</span> <span class="DecNumber">0</span><span class="Punctuation">:</span>
    <span class="Identifier">result</span><span class="Operator">.</span><span class="Identifier">le</span> <span class="Operator">=</span> <span class="Keyword">nil</span>
    <span class="Identifier">result</span><span class="Operator">.</span><span class="Identifier">ri</span> <span class="Operator">=</span> <span class="Keyword">nil</span>
  <span class="Keyword">else</span><span class="Punctuation">:</span>
    <span class="Identifier">result</span><span class="Operator">.</span><span class="Identifier">le</span> <span class="Operator">=</span> <span class="Identifier">makeTree</span><span class="Punctuation">(</span><span class="Identifier">p</span><span class="Punctuation">,</span> <span class="Identifier">depth</span><span class="Operator">-</span><span class="DecNumber">1</span><span class="Punctuation">)</span>
    <span class="Identifier">result</span><span class="Operator">.</span><span class="Identifier">ri</span> <span class="Operator">=</span> <span class="Identifier">makeTree</span><span class="Punctuation">(</span><span class="Identifier">p</span><span class="Punctuation">,</span> <span class="Identifier">depth</span><span class="Operator">-</span><span class="DecNumber">1</span><span class="Punctuation">)</span></pre></td></tr></tbody></table>
</div>
<div class="slide">
<h1 id="object-pooling-5">Object pooling (5)</h1><table class="line-nums-table"><tbody><tr><td class="blob-line-nums"><pre class="line-nums">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td><pre id="listing_31" class="listing"><span class="Keyword">proc</span> <span class="Identifier">main</span> <span class="Operator">=</span>
  <span class="Keyword">let</span> <span class="Identifier">maxDepth</span> <span class="Operator">=</span> <span class="Identifier">parseInt</span><span class="Punctuation">(</span><span class="Identifier">paramStr</span><span class="Punctuation">(</span><span class="DecNumber">1</span><span class="Punctuation">)</span><span class="Punctuation">)</span>
  <span class="Keyword">const</span> <span class="Identifier">minDepth</span> <span class="Operator">=</span> <span class="DecNumber">4</span>
  <span class="Keyword">let</span> <span class="Identifier">stretchDepth</span> <span class="Operator">=</span> <span class="Identifier">maxDepth</span> <span class="Operator">+</span> <span class="DecNumber">1</span>
  <span class="Keyword">var</span> <span class="Identifier">longLived</span><span class="Punctuation">:</span> <span class="Identifier">Pool</span>
  <span class="Keyword">let</span> <span class="Identifier">stree</span> <span class="Operator">=</span> <span class="Identifier">makeTree</span><span class="Punctuation">(</span><span class="Identifier">longLived</span><span class="Punctuation">,</span> <span class="Identifier">stretchDepth</span><span class="Punctuation">)</span>
  <span class="Identifier">echo</span><span class="Punctuation">(</span><span class="StringLit">&quot;stretch tree of depth &quot;</span><span class="Punctuation">,</span> <span class="Identifier">stretchDepth</span><span class="Punctuation">,</span> <span class="StringLit">&quot;</span><span class="EscapeSequence">\t</span><span class="StringLit"> check:&quot;</span><span class="Punctuation">,</span>
    <span class="Identifier">checkTree</span> <span class="Identifier">stree</span><span class="Punctuation">)</span>
  <span class="Keyword">let</span> <span class="Identifier">longLivedTree</span> <span class="Operator">=</span> <span class="Identifier">makeTree</span><span class="Punctuation">(</span><span class="Identifier">longLived</span><span class="Punctuation">,</span> <span class="Identifier">maxDepth</span><span class="Punctuation">)</span>
  <span class="Keyword">var</span> <span class="Identifier">iterations</span> <span class="Operator">=</span> <span class="DecNumber">1</span> <span class="Keyword">shl</span> <span class="Identifier">maxDepth</span>
  <span class="Keyword">for</span> <span class="Identifier">depth</span> <span class="Keyword">in</span> <span class="Identifier">countup</span><span class="Punctuation">(</span><span class="Identifier">minDepth</span><span class="Punctuation">,</span> <span class="Identifier">maxDepth</span><span class="Punctuation">,</span> <span class="DecNumber">2</span><span class="Punctuation">)</span><span class="Punctuation">:</span>
    <span class="Keyword">var</span> <span class="Identifier">check</span> <span class="Operator">=</span> <span class="DecNumber">0</span>
    <span class="Keyword">for</span> <span class="Identifier">i</span> <span class="Keyword">in</span> <span class="FloatNumber">1.</span><span class="Operator">.</span><span class="Identifier">iterations</span><span class="Punctuation">:</span>
      <span class="Keyword">var</span> <span class="Identifier">shortLived</span><span class="Punctuation">:</span> <span class="Identifier">Pool</span>
      <span class="Identifier">check</span> <span class="Operator">+=</span> <span class="Identifier">checkTree</span><span class="Punctuation">(</span><span class="Identifier">makeTree</span><span class="Punctuation">(</span><span class="Identifier">shortLived</span><span class="Punctuation">,</span> <span class="Identifier">depth</span><span class="Punctuation">)</span><span class="Punctuation">)</span>
    <span class="Identifier">echo</span> <span class="Identifier">iterations</span><span class="Punctuation">,</span> <span class="StringLit">&quot;</span><span class="EscapeSequence">\t</span><span class="StringLit"> trees of depth &quot;</span><span class="Punctuation">,</span> <span class="Identifier">depth</span><span class="Punctuation">,</span> <span class="StringLit">&quot;</span><span class="EscapeSequence">\t</span><span class="StringLit"> check:&quot;</span><span class="Punctuation">,</span> <span class="Identifier">check</span>
    <span class="Identifier">iterations</span> <span class="Operator">=</span> <span class="Identifier">iterations</span> <span class="Keyword">div</span> <span class="DecNumber">4</span>

<span class="Identifier">main</span><span class="Punctuation">(</span><span class="Punctuation">)</span></pre></td></tr></tbody></table>
</div>
<div class="slide">
<h1 id="benchmarkcolon-throughput">Benchmark: Throughput</h1><table border="1" class="docutils"><tr><th>Memory management strategy</th><th>Time</th><th>Peak Memory</th></tr>
<tr><td>mark&amp;sweep GC</td><td>17s</td><td>588.047MiB</td></tr>
<tr><td>deferred refcounting GC</td><td>16s</td><td>304.074MiB</td></tr>
<tr><td>Boehm GC</td><td>12s</td><td>N/A</td></tr>
<tr><td>ARC</td><td>7.8s</td><td>740.715MiB</td></tr>
<tr><td>manual memory management</td><td>6.75s</td><td>473.195MiB</td></tr>
<tr><td>object pooling</td><td><strong>2.4s</strong></td><td>251.504MiB</td></tr>
</table>
</div>
<div class="slide">
<h1 id="summary">Summary</h1><ul class="simple"><li>Move semantics mostly work under the hood.</li>
<li><tt class="docutils literal"><span class="pre">sink</span></tt> and <tt class="docutils literal"><span class="pre">lent</span></tt> annotations are optional.</li>
<li>Lead to incredible speedups and algorithmic improvements.</li>
<li>Make Nim faster and &quot;deterministic&quot;.</li>
<li>New strategy improves:<ul class="simple"><li>throughput</li>
<li>latency</li>
<li>memory consumption</li>
<li>threading</li>
<li>ease of programming</li>
<li>flexibility / composition</li>
</ul>
</li>
</ul>

</div>
<div class="slide">
<h1 id="happy-hackingemark">Happy hacking!</h1><p>Source code available under <a class="reference external" href="https://github.com/araq/fosdem2020">https://github.com/araq/fosdem2020</a>.</p>
<table border="1" class="docutils"><tr><td>Website</td><td><a class="reference external" href="https://nim-lang.org">https://nim-lang.org</a></td></tr>
<tr><td>Forum</td><td><a class="reference external" href="https://forum.nim-lang.org">https://forum.nim-lang.org</a></td></tr>
<tr><td>Github</td><td><a class="reference external" href="https://github.com/nim-lang/Nim">https://github.com/nim-lang/Nim</a></td></tr>
<tr><td>IRC</td><td>irc.freenode.net/nim</td></tr>
</table>


</body>
</div>
</html>
